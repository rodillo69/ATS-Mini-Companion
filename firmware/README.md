# ATS Mini Custom Firmware - Bluetooth Edition

[üá™üá∏ Espa√±ol](#espa√±ol) | [üá¨üáß English](#english)

---

## English

Custom firmware for ATS Mini radio receiver with Bluetooth LE support and custom boot logo.

**Version**: 1.4
**Date**: October 20, 2025
**Hardware**: ESP32-S3-WROOM-1-N16R8 (16MB Flash + 8MB PSRAM)

### ‚ú® Features

- ‚úÖ **Bluetooth LE** with Nordic UART Service (NUS)
- ‚úÖ **WiFi/BLE automatic mutual exclusion** (only one active at a time)
- ‚úÖ **Custom boot logo** (2 seconds at startup)
- ‚úÖ **Logo embedded in firmware** (no SPIFFS required)
- ‚úÖ **Compatible with USB Serial** (dual mode)
- ‚úÖ **Low power consumption** with BLE optimization

### üì¶ Precompiled Binaries

Located in [`binaries/`](binaries/) directory:

#### Option A - Single File (‚≠ê RECOMMENDED)
- **`ats-mini.ino.merged.bin`** (16 MB)
  - All-in-one: bootloader + partitions + firmware + boot logo
  - Flash at address **0x0**
  - Custom logo included (displays for 2 seconds at boot)

#### Option B - Separate Files
- **`ats-mini.ino.bootloader.bin`** (20 KB) ‚Üí Flash at **0x0**
- **`ats-mini.ino.partitions.bin`** (3 KB) ‚Üí Flash at **0x8000**
- **`ats-mini.ino.bin`** (1.7 MB) ‚Üí Flash at **0x10000**

### üöÄ Quick Start - Flash Firmware

#### Method 1: Web Browser (Easiest - Chrome/Edge only)

1. Open https://espressif.github.io/esptool-js/
2. Connect ATS Mini via USB and power it on
3. Click "Connect" and select the serial port
4. Add `binaries/ats-mini.ino.merged.bin` at address **0x0**
5. Click "Program"
6. Wait for "Leaving... Hard resetting via RTS pin..."
7. Power cycle the receiver

#### Method 2: esptool.py (Mac/Linux/Windows)

**Install esptool:**
```bash
pip install esptool
```

**Flash merged firmware (recommended):**
```bash
# Mac/Linux
esptool.py --chip esp32s3 --port /dev/cu.usbmodem101 \
  --baud 921600 write_flash 0x0 binaries/ats-mini.ino.merged.bin

# Windows
esptool.py --chip esp32s3 --port COM3 \
  --baud 921600 write_flash 0x0 binaries\ats-mini.ino.merged.bin
```

**Flash separate files:**
```bash
# Mac/Linux
esptool.py --chip esp32s3 --port /dev/cu.usbmodem101 \
  --baud 921600 write_flash \
  0x0 binaries/ats-mini.ino.bootloader.bin \
  0x8000 binaries/ats-mini.ino.partitions.bin \
  0x10000 binaries/ats-mini.ino.bin

# Windows
esptool.py --chip esp32s3 --port COM3 \
  --baud 921600 write_flash \
  0x0 binaries\ats-mini.ino.bootloader.bin \
  0x8000 binaries\ats-mini.ino.partitions.bin \
  0x10000 binaries\ats-mini.ino.bin
```

For detailed instructions, see [`binaries/FLASH_INSTRUCTIONS.md`](binaries/FLASH_INSTRUCTIONS.md)

### üìñ Documentation

- [`binaries/FLASH_INSTRUCTIONS.md`](binaries/FLASH_INSTRUCTIONS.md) - Complete flashing guide
- [`docs/BLUETOOTH_IMPLEMENTATION.md`](docs/BLUETOOTH_IMPLEMENTATION.md) - Technical implementation details
- [`docs/NOTAS_VERSION.md`](docs/NOTAS_VERSION.md) - Version release notes

### üõ†Ô∏è Development Setup

#### Prerequisites

- **Arduino IDE 2.x** or **PlatformIO**
- **ESP32 Arduino Core 3.0+**
- **USB-C cable** for programming
- **ATS Mini hardware**

#### Required Libraries

Install via Arduino Library Manager or PlatformIO:

```
SI4735 by PU2CLR (pu2clr/SI4735)
TFT_eSPI
NimBLE-Arduino
Preferences (included in ESP32 core)
WiFi (included in ESP32 core)
```

#### Arduino IDE Setup

1. **Install ESP32 Board Support**
   - Open Arduino IDE
   - File > Preferences
   - Add to "Additional Board Manager URLs":
     ```
     https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
     ```
   - Tools > Board > Boards Manager
   - Search "esp32" and install "esp32 by Espressif Systems" (v3.0+)

2. **Board Configuration**
   - Board: "ESP32S3 Dev Module"
   - USB CDC On Boot: "Enabled"
   - Flash Size: "16MB (128Mb)"
   - PSRAM: "OPI PSRAM"
   - Partition Scheme: "16M Flash (3MB APP/9.9MB FATFS)"
   - Upload Speed: "921600"

3. **Configure TFT_eSPI**
   - Edit `libraries/TFT_eSPI/User_Setup.h`
   - Or use the `tft_setup.h` configuration from this project

#### Build from Source

1. **Clone the Repository**
   ```bash
   git clone https://github.com/rodillo69/ATS-Mini-Companion.git
   cd ATS-Mini-Companion/firmware/ats-mini
   ```

2. **Open in Arduino IDE**
   ```bash
   # Open ats-mini.ino
   open ats-mini/ats-mini.ino  # macOS
   ```

3. **Install Dependencies**
   - Tools > Manage Libraries
   - Install all required libraries listed above

4. **Compile**
   - Sketch > Verify/Compile
   - Check for errors

5. **Upload**
   - Connect ATS Mini via USB
   - Tools > Port > Select your port
   - Sketch > Upload

#### PlatformIO Setup

```ini
[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

board_build.flash_size = 16MB
board_build.psram_type = opi
board_build.partitions = default_16MB.csv

lib_deps =
    pu2clr/SI4735@^2.1.4
    bodmer/TFT_eSPI@^2.5.0
    h2zero/NimBLE-Arduino@^1.4.0

build_flags =
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_CDC_ON_BOOT=1
```

### üìÇ Source Code Structure

```
firmware/
‚îú‚îÄ‚îÄ ats-mini/                   # Arduino source code
‚îÇ   ‚îú‚îÄ‚îÄ ats-mini.ino           # Main sketch
‚îÇ   ‚îú‚îÄ‚îÄ Ble.cpp / Ble.h        # Bluetooth LE module
‚îÇ   ‚îú‚îÄ‚îÄ Network.cpp            # WiFi module
‚îÇ   ‚îú‚îÄ‚îÄ Common.h               # Common definitions
‚îÇ   ‚îú‚îÄ‚îÄ SI4735-fixed.h         # Radio chip interface
‚îÇ   ‚îú‚îÄ‚îÄ Storage.cpp            # EEPROM/Preferences
‚îÇ   ‚îú‚îÄ‚îÄ Draw.cpp               # Display rendering
‚îÇ   ‚îú‚îÄ‚îÄ Menu.cpp               # Menu system
‚îÇ   ‚îú‚îÄ‚îÄ Scan.cpp               # Frequency scanning
‚îÇ   ‚îú‚îÄ‚îÄ Utils.cpp              # Utilities
‚îÇ   ‚îú‚îÄ‚îÄ EIBI.cpp               # Station database
‚îÇ   ‚îú‚îÄ‚îÄ splash_data.h          # Boot logo data
‚îÇ   ‚îî‚îÄ‚îÄ tft_setup.h            # Display configuration
‚îÇ
‚îú‚îÄ‚îÄ binaries/                   # Compiled firmware
‚îÇ   ‚îú‚îÄ‚îÄ ats-mini.ino.merged.bin
‚îÇ   ‚îú‚îÄ‚îÄ ats-mini.ino.bootloader.bin
‚îÇ   ‚îú‚îÄ‚îÄ ats-mini.ino.partitions.bin
‚îÇ   ‚îú‚îÄ‚îÄ ats-mini.ino.bin
‚îÇ   ‚îú‚îÄ‚îÄ CHECKSUMS.txt
‚îÇ   ‚îî‚îÄ‚îÄ FLASH_INSTRUCTIONS.md
‚îÇ
‚îú‚îÄ‚îÄ docs/                       # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ BLUETOOTH_IMPLEMENTATION.md
‚îÇ   ‚îî‚îÄ‚îÄ NOTAS_VERSION.md
‚îÇ
‚îî‚îÄ‚îÄ README.md                   # This file
```

### üîß Key Modules

#### Bluetooth LE (`Ble.cpp / Ble.h`)
- **Service**: Nordic UART Service (NUS)
- **UUIDs**:
  - Service: `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`
  - RX (Write): `6E400002-B5A3-F393-E0A9-E50E24DCCA9E`
  - TX (Notify): `6E400003-B5A3-F393-E0A9-E50E24DCCA9E`
- **Features**:
  - Command reception via RX characteristic
  - Status broadcast via TX characteristic (every 500ms)
  - Automatic WiFi/BLE mutual exclusion
  - Connection state management

#### WiFi Management (`Network.cpp`)
- Automatic disconnection when BLE activates
- WiFi station and AP modes
- NTP time synchronization

#### Radio Control (`SI4735-fixed.h`)
- SI4735/SI4732 chip interface
- AM/FM/SSB modes
- Frequency tuning
- Signal quality monitoring

#### Display (`Draw.cpp`)
- TFT display rendering
- Custom boot logo
- UI updates
- Theme support

### üî® Customization

#### Change Boot Logo

1. **Create your image**
   - Size: 320x170 pixels
   - Format: RGB565 (16-bit color)

2. **Convert to C array**
   ```bash
   # Use image2cpp or similar tool
   # Output format: const uint16_t splash_data[] PROGMEM = { ... };
   ```

3. **Replace in `splash_data.h`**
   ```cpp
   #define SPLASH_WIDTH 320
   #define SPLASH_HEIGHT 170
   const uint16_t splash_data[] PROGMEM = {
     // Your image data here
   };
   ```

4. **Recompile and flash**

#### Modify Bluetooth Behavior

Edit `Ble.cpp`:

```cpp
// Change device name
#define BLE_DEVICE_NAME "Your-Custom-Name"

// Change broadcast interval
#define BLE_STATUS_INTERVAL 500  // milliseconds

// Modify status data format
String bleGetStatusData() {
  // Customize CSV format
  return customData;
}
```

### üêõ Troubleshooting

#### Compilation Errors

**Error**: `TFT_eSPI.h: No such file or directory`
```bash
# Install TFT_eSPI library
arduino-cli lib install "TFT_eSPI"
```

**Error**: `NimBLEDevice.h: No such file or directory`
```bash
# Install NimBLE-Arduino library
arduino-cli lib install "NimBLE-Arduino"
```

**Error**: `SI4735.h: No such file or directory`
```bash
# Install SI4735 library
arduino-cli lib install "SI4735"
```

#### Upload Issues

**Problem**: Board not detected
- Check USB cable (must support data transfer)
- Install CP210x or CH340 drivers if needed
- Try different USB port

**Problem**: Upload fails
- Enter bootloader mode: Hold BOOT + press RESET
- Release RESET, then release BOOT
- Try upload again

**Problem**: "Timed out waiting for packet header"
- Lower baud rate: Tools > Upload Speed > 115200
- Check USB cable quality
- Try shorter USB cable

### üìä Technical Specifications

#### Hardware
- **MCU**: ESP32-S3-WROOM-1-N16R8
- **Flash**: 16MB
- **PSRAM**: 8MB OPI QSPI
- **Radio Chip**: SI4735/SI4732
- **Display**: 320x170 TFT LCD

#### Firmware
- **Framework**: Arduino ESP32 v3.0+
- **BLE Stack**: NimBLE
- **Size**: ~1.7MB (86% flash usage)
- **RAM Usage**: ~200KB

#### BLE Protocol
- **Service**: Nordic UART Service (NUS)
- **MTU**: 512 bytes
- **Data Format**: CSV (15 fields)
- **Update Rate**: 500ms
- **Range**: ~10 meters

### üìú Version History

#### v1.4 (Current - Bluetooth Edition)
- **NEW**: Bluetooth LE with Nordic UART Service
- **NEW**: WiFi/BLE automatic mutual exclusion
- **NEW**: Custom boot logo embedded in firmware
- **IMPROVED**: Memory management
- **IMPROVED**: Connection stability

### üìÑ License

This project is based on the original ATS Mini firmware and is licensed under MIT License.

### üôè Credits

- **Original ATS Mini**: ESP32-SI4732 community
- **SI4735 Library**: PU2CLR (Ricardo Lima Caratti)
- **Bluetooth Implementation**: EA5IYR - Miguel Ca√±adas

---

## Espa√±ol

Firmware personalizado para el receptor de radio ATS Mini con soporte Bluetooth LE y logo de arranque personalizado.

**Versi√≥n**: 1.4
**Fecha**: 20 Octubre 2025
**Hardware**: ESP32-S3-WROOM-1-N16R8 (16MB Flash + 8MB PSRAM)

### ‚ú® Caracter√≠sticas

- ‚úÖ **Bluetooth LE** con Nordic UART Service (NUS)
- ‚úÖ **Exclusi√≥n mutua WiFi/BLE autom√°tica** (solo uno activo a la vez)
- ‚úÖ **Logo personalizado al arranque** (2 segundos al inicio)
- ‚úÖ **Logo embebido en firmware** (no requiere SPIFFS)
- ‚úÖ **Compatible con USB Serial** (modo dual)
- ‚úÖ **Bajo consumo** con optimizaci√≥n BLE

### üì¶ Binarios Precompilados

Ubicados en el directorio [`binaries/`](binaries/):

#### Opci√≥n A - Archivo √önico (‚≠ê RECOMENDADO)
- **`ats-mini.ino.merged.bin`** (16 MB)
  - Todo en uno: bootloader + particiones + firmware + logo
  - Flashear en direcci√≥n **0x0**
  - Logo personalizado incluido (se muestra 2 segundos al arrancar)

#### Opci√≥n B - Archivos Separados
- **`ats-mini.ino.bootloader.bin`** (20 KB) ‚Üí Flashear en **0x0**
- **`ats-mini.ino.partitions.bin`** (3 KB) ‚Üí Flashear en **0x8000**
- **`ats-mini.ino.bin`** (1.7 MB) ‚Üí Flashear en **0x10000**

### üöÄ Inicio R√°pido - Flashear Firmware

#### M√©todo 1: Navegador Web (M√°s f√°cil - Solo Chrome/Edge)

1. Abrir https://espressif.github.io/esptool-js/
2. Conectar ATS Mini por USB y encender
3. Clic en "Connect" y seleccionar puerto serial
4. A√±adir `binaries/ats-mini.ino.merged.bin` en direcci√≥n **0x0**
5. Clic en "Program"
6. Esperar "Leaving... Hard resetting via RTS pin..."
7. Reiniciar el receptor

#### M√©todo 2: esptool.py (Mac/Linux/Windows)

**Instalar esptool:**
```bash
pip install esptool
```

**Flashear firmware merged (recomendado):**
```bash
# Mac/Linux
esptool.py --chip esp32s3 --port /dev/cu.usbmodem101 \
  --baud 921600 write_flash 0x0 binaries/ats-mini.ino.merged.bin

# Windows
esptool.py --chip esp32s3 --port COM3 \
  --baud 921600 write_flash 0x0 binaries\ats-mini.ino.merged.bin
```

**Flashear archivos separados:**
```bash
# Mac/Linux
esptool.py --chip esp32s3 --port /dev/cu.usbmodem101 \
  --baud 921600 write_flash \
  0x0 binaries/ats-mini.ino.bootloader.bin \
  0x8000 binaries/ats-mini.ino.partitions.bin \
  0x10000 binaries/ats-mini.ino.bin

# Windows
esptool.py --chip esp32s3 --port COM3 \
  --baud 921600 write_flash \
  0x0 binaries\ats-mini.ino.bootloader.bin \
  0x8000 binaries\ats-mini.ino.partitions.bin \
  0x10000 binaries\ats-mini.ino.bin
```

Para instrucciones detalladas, ver [`binaries/FLASH_INSTRUCTIONS.md`](binaries/FLASH_INSTRUCTIONS.md)

### üìñ Documentaci√≥n

- [`binaries/FLASH_INSTRUCTIONS.md`](binaries/FLASH_INSTRUCTIONS.md) - Gu√≠a completa de flasheo
- [`docs/BLUETOOTH_IMPLEMENTATION.md`](docs/BLUETOOTH_IMPLEMENTATION.md) - Detalles t√©cnicos de implementaci√≥n
- [`docs/NOTAS_VERSION.md`](docs/NOTAS_VERSION.md) - Notas de la versi√≥n

### üõ†Ô∏è Configuraci√≥n de Desarrollo

#### Requisitos Previos

- **Arduino IDE 2.x** o **PlatformIO**
- **ESP32 Arduino Core 3.0+**
- **Cable USB-C** para programaci√≥n
- **Hardware ATS Mini**

#### Librer√≠as Requeridas

Instalar v√≠a Arduino Library Manager o PlatformIO:

```
SI4735 by PU2CLR (pu2clr/SI4735)
TFT_eSPI
NimBLE-Arduino
Preferences (incluida en ESP32 core)
WiFi (incluida en ESP32 core)
```

#### Configuraci√≥n Arduino IDE

1. **Instalar Soporte para ESP32**
   - Abrir Arduino IDE
   - Archivo > Preferencias
   - A√±adir a "Gestor de URLs Adicionales de Tarjetas":
     ```
     https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
     ```
   - Herramientas > Placa > Gestor de Tarjetas
   - Buscar "esp32" e instalar "esp32 by Espressif Systems" (v3.0+)

2. **Configuraci√≥n de la Placa**
   - Placa: "ESP32S3 Dev Module"
   - USB CDC On Boot: "Enabled"
   - Flash Size: "16MB (128Mb)"
   - PSRAM: "OPI PSRAM"
   - Partition Scheme: "16M Flash (3MB APP/9.9MB FATFS)"
   - Upload Speed: "921600"

3. **Configurar TFT_eSPI**
   - Editar `libraries/TFT_eSPI/User_Setup.h`
   - O usar la configuraci√≥n `tft_setup.h` de este proyecto

#### Compilar desde C√≥digo Fuente

1. **Clonar el Repositorio**
   ```bash
   git clone https://github.com/rodillo69/ATS-Mini-Companion.git
   cd ATS-Mini-Companion/firmware/ats-mini
   ```

2. **Abrir en Arduino IDE**
   ```bash
   # Abrir ats-mini.ino
   open ats-mini/ats-mini.ino  # macOS
   ```

3. **Instalar Dependencias**
   - Herramientas > Administrar Bibliotecas
   - Instalar todas las librer√≠as requeridas listadas arriba

4. **Compilar**
   - Programa > Verificar/Compilar
   - Verificar errores

5. **Subir**
   - Conectar ATS Mini por USB
   - Herramientas > Puerto > Seleccionar tu puerto
   - Programa > Subir

Para m√°s detalles sobre desarrollo y personalizaci√≥n, ver la secci√≥n en ingl√©s arriba.

### üìÑ Licencia

Este proyecto est√° basado en el firmware original ATS Mini y est√° licenciado bajo MIT License.

### üôè Cr√©ditos

- **ATS Mini Original**: Comunidad ESP32-SI4732
- **Librer√≠a SI4735**: PU2CLR (Ricardo Lima Caratti)
- **Implementaci√≥n Bluetooth**: EA5IYR - Miguel Ca√±adas
